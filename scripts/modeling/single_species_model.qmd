---
title: "single_species_model"
format: html
---

```{r}
# Load packages
library(tidyverse)
library(dplyr)
library(SSDM)
library(biooracler)
library(raster)
library(terra)
library(purrr)
library(shinyFiles) # For ssdm shiny interface
library(here)

# Load functions 
source(here::here('scripts', 'functions', 'clean_biodiv.R'))
```

### Read in data

One way to read in data, not compatible with modelling

```{r}
# Define path to your rasters using here()
raster_path <- here("data", "raw", "BioOrc_rasters")
# Read and stack rasters
env_00 <- terra::rast(list.files(raster_path, pattern = "mean_00.tif$", full.names = TRUE))
# Optional: Check names
names(env_00)
```
```{r}
# Define path to your rasters using here()
raster_path <- here("data", "raw", "BioOrc_rasters")
# Read and stack rasters
env_50 <- terra::rast(list.files(raster_path, pattern = "mean_50.tif$", full.names = TRUE))
# Optional: Check names
names(env_50)
```
```{r}
# Read in biodiversity data 
biodiv_2025 <- clean_biodiv(cbs_excel_name = 'cbs_data_2025.xlsx', 
                              point_contact_sheet = 'point_contact_summary_layered',
                              quadrat_sheet = 'quadrat_summary_data',
                              swath_sheet = 'swath_summary_data')
```

### Read in data using load_var

This worked!


##### Loading in for 00
```{r}
env_00_load <- load_var(path = here("data", "raw", "BioOrc_rasters", "env_00"), files = NULL, format = ".tif")
```

##### Loading in for 50

```{r}
env_50_load <- load_var(path = here("data", "raw", "BioOrc_rasters", "env_50"), files = NULL, format = ".tif")
```

### Modeling with Alaria marginata

##### Formatting data 
```{r}
# Filter to alaria
alaria_data <- biodiv_2025 %>% 
  filter(species_lump == "Alaria marginata")
```

```{r}
# Formatting observation data
alaria_obs <- alaria_data |>
  group_by(species_lump, latitude, longitude) |>
  summarise(num_count = sum(total_count)) |>
  ungroup()
```


```{r}
# Expand rows & keep observation column
alaria_obs_present <- alaria_obs |>
  filter(num_count >=1 ) |>
  uncount(num_count) 
```


### Running SDMs, GLM AND GAM

For individual species model with one model type

```{r}
# GLM
SDM_glm <- modelling('GLM', subset(alaria_obs_present, alaria_obs_present$species_lump == 'Alaria marginata'), 
                 env_00_load, Xcol = 'longitude', Ycol = 'latitude', verbose = FALSE)
plot(SDM@projection, main = 'SDM\nfor Alaria marginata\nwith GLM algorithm')
```

```{r}
# GAM model
SDM_gam <- modelling('GAM', subset(alaria_obs_present, alaria_obs_present$species_lump == 'Alaria marginata'), 
                 env_00_load, Xcol = 'longitude', Ycol = 'latitude', verbose = FALSE)
plot(SDM@projection, main = 'SDM\nfor Alaria marginata\nwith GAM algorithm')
```
## Ensemble Species Model 

```{r}
ESDM <- ensemble_modelling(c('GAM', 'GLM'), subset(alaria_obs_present, alaria_obs_present$species_lump == 'Alaria marginata'),
                           env_00_load, rep = 1, Xcol = 'longitude', Ycol = 'latitude',
                          ensemble.thresh = 0, verbose = FALSE)
plot(ESDM@projection, main = 'ESDM\nfor Alaria marginata\nwith GAM and GLM algorithms')
```
##### Model accuracy assesment
```{r}
knitr::kable(ESDM@evaluation)
```
```{r}
knitr::kable(ESDM@variable.importance)
```

```{r}
plot(ESDM)
```

### Model Forcasting

Trying to use the `project()` with projected env data.

```{r}
SDM_projection <- SSDM::project(ESDM, env_50_load, output.format = "model")
```

