---
title: "Range Shift Analysis"
format: html
editor_options: 
  chunk_output_type: console
---

## Load packages
```{r}
#| code-fold: true
library(here)
library(readr)
library(lubridate)
library(tidyverse)
library(stats)
```

## Read data
```{r}
# Source cleaning function
source(here("scripts", "functions", "clean_biodiv.R"))
source(here("scripts", "functions", "cumulative_density_dataframe.R"))
source(here("scripts", "functions", "range_extent_prediction.R"))
source(here("scripts", "functions", "cumulative_density_graph.R"))

biodiv_df <- clean_biodiv()
ggsave("RopPou_cumulative.png", cumulative_den_graph("Roperia poulsoni"), bg="white")
```

```{r}
# Load data
species_extent <- read_csv("/capstone/coastalconservation/data/processed/species_extent.csv")
marine_path <- read_csv("/capstone/coastalconservation/data/processed/marine_site_segments.csv")
biodiv_df <- clean_biodiv()

northern_dangermond_range_edges <- species_extent %>% 
  filter(northern_extent_id %in% (2:8))

northern_dangermond_species_list <- northern_dangermond_range_edges$species_lump %>% unique()
```


```{r}
biodiv_distances <- biodiv_df %>% 
             left_join(
              marine_path %>%
              select(marine_site_name, coastline_km)
              )
```

```{r}
northern_cum_den <- cum_den_df(biodiv_df) %>% 
  filter(species_lump %in% northern_dangermond_species_list) %>% 
  filter(state_province=="California")
```


```{r}
cum_den_df(biodiv_df) %>%
  group_by(state_province) %>%
  slice_max(order_by = coastline_km, n = 1, with_ties = FALSE)
```

## Macron lividus
```{r}
# max latitude ever
max((biodiv_df %>% 
      filter(species_lump=="Macron lividus",
            (density_per_m2>0|total_count>0)))$latitude)

# Roperia poulsoni has Northern Range edge in Southern Dangermond

ggsave("RopPou_cumulative.png", cumulative_den_graph("Roperia poulsoni"), bg="white")
range_extent_graph("Macron lividus")
```

```{r}
ggplot(biodiv_df %>% filter(species_lump=="Roperia poulsoni"),
       aes(x=year, y=latitude, aes=density_per_m2)) +
  geom_point()
```

# Min and Max lat

```{r}
biodiv_df %>% 
  filter(species_lump %in% northern_dangermond_species_list) %>% 
  filter(!is.na(density_per_m2)) %>% 
  group_by(year) %>% 
  summarise(min_lat = min(latitude),
            max_lat = max(latitude)) %>% 
  View()
```
