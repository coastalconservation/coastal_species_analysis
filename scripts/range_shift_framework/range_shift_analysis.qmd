---
title: "Range Shift Analysis"
format: html
editor_options: 
  chunk_output_type: console
---

## Load packages
```{r}
#| code-fold: true
library(here)
library(readr)
library(lubridate)
library(tidyverse)
library(stats)
```

## Read data
```{r}
# Source cleaning function
source(here("scripts", "functions", "clean_biodiv.R"))
source(here("scripts", "functions", "cumulative_density_dataframe.R"))
source(here("scripts", "functions", "range_extent_prediction.R"))
source(here("scripts", "functions", "cumulative_density_graph.R"))
```

```{r}
# Load data
range_edges <- read_csv(here("data", "processed", "range_list.csv"))
marine_path <- "/capstone/coastalconservation/data/processed/marine_site_segments.csv"
marine_site_segments <- read_csv(marine_path)

# Pull species with range edges in Dangermond

# Looking 2 - 8, only northern range edges
# eventually use fill list. and filter out within the function 
northern_dangermond_range_edges <- range_edges %>%
  filter(segment_id %in% (2:8)) %>% 
  filter(range_edge_category == "Northern Range Edge") %>% 
  # select(segment_name, segment_id, species_lump, total_counts, counts_in_buffer,
  #        percent_years_present, sites_in_buffer, range_edge_category) %>% 
  arrange(desc(segment_id)) %>%
  mutate(percent_years_present = round(percent_years_present, digits=2))

northern_dangermond_species_list <- northern_dangermond_range_edges$species_lump %>% unique()
```


```{r}
biodiv_df <- clean_biodiv('cbs_data_2025.xlsx',
                              point_contact_sheet = 'point_contact_summary_layered',
                              quadrat_sheet = 'quadrat_summary_data',
                              swath_sheet = 'swath_summary_data') %>% 
             left_join(
              marine_site_segments %>%
              select(latitude, segment_id, segment_name, coastline_km))
```

```{r}
northern_cum_den <- cum_den_df(biodiv_df) %>% 
  filter(species_lump %in% northern_dangermond_species_list) %>% 
  filter(state_province=="California")
```

```{r}
north_logit <- glm(cum_den_norm ~ latitude * year, binomial(link="logit"), northern_cum_den)
```

```{r}
north_pred <- expand_grid(latitude = seq(32, 36, length.out=1000),
                          year = 2000:2024) %>% 
  mutate(
    cum_den_norm = predict(north_logit, newdata = ., type="response")
  ) 
```

```{r}
library(car)
Anova(north_logit)
coef(north_logit)
summary(north_logit)
```


```{r}
ggplot(northern_cum_den, aes(x=latitude, y=cum_den_norm, color=year)) +
 geom_point() +
  geom_line(aes(group = year), data=north_pred) +
  xlim(32, 36) +
  geom_hline(yintercept=.95) +
  labs(title = "Northern Range Edge Species Cumulative Density")
```

Dangemond Lat -> 34.449

```{r}
northern_95 <- north_pred %>% 
  group_by(year) %>% 
  summarise(
    max_lat = approx(cum_den_norm, latitude, xout=0.95)$y,
    min_lat = approx(cum_den_norm, latitude, xout=0.05)$y
  )

ggplot(northern_95) +
  geom_point(aes(year, max_lat), color="red") +
  geom_point(aes(year, min_lat), color="blue") +
  geom_hline(yintercept = 34.449)
```




## Roperia poulsoni
```{r}
# max latitude ever
max((biodiv_df %>% filter(species_lump=="Roperia poulsoni", density_per_m2>0))$latitude)

# Roperia poulsoni has Northern Range edge in Southern Dangermond
cumulative_den_graph("Roperia poulsoni")
range_extent_graph("Roperia poulsoni")
```

```{r}
ggplot(biodiv_df %>% filter(species_lump=="Roperia poulsoni"),
       aes(x=year, y=latitude, aes=density_per_m2)) +
  geom_point()
```


## Split data
```{r}
northern_cum_den_split <- cum_den_df(biodiv_df) %>% 
  filter(species_lump %in% northern_dangermond_species_list) %>% 
  group_by(species_lump) %>% 
  group_split()
```

# Min and Max lat

```{r}
biodiv_df %>% 
  filter(species_lump %in% northern_dangermond_species_list) %>% 
  filter(!is.na(density_per_m2)) %>% 
  group_by(year) %>% 
  summarise(min_lat = min(latitude),
            max_lat = max(latitude)) %>% 
  View()
```

# ECDF

```{r}
ggplot(northern_cum_den,
       aes(x = latitude)) +
  # Plot the Normalized CDF
  geom_line(aes(y = cum_den_norm, color = "Normalized CDF"), size = 1) +
  
  # Plot the Empirical CDF (if available)
  # geom_line(aes(y = ecdf_values, color = "Empirical CDF"), size = 1) +
  
  # Facet by 5-year bin
  facet_wrap(~ year_bin, scales = "free_x") +
  
  # Labels and title
  labs(
    title = "Normalized vs Empirical CDF for Tegula aureotincta by 5-Year Bins",
    x = "Latitude",
    y = "Cumulative Probability",
    color = "Distribution Type"
  ) +
  
  # Custom color mapping
  scale_color_manual(values = c("Normalized CDF" = "blue", "Empirical CDF" = "red")) +
  
  # Theme styling
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )

```

## Matteo
Ë†

### Using density per meter squared
```{r}
# Northern Range Edge (2000-2024)
biodiv_df %>%
  filter(species_lump == "Tegula aureotincta",
         latitude > 32.53 & latitude < 35.88) %>% # Northern Range Edge
  ggplot(aes(x = density_per_m2)) +
  stat_ecdf(geom = "step") +
  labs(title = "Empirical Cumulative Distribution Function") +
  theme_bw()

# Every 5 years
biodiv_df %>%
  filter(species_lump == "Tegula aureotincta",
         latitude > 32.53 & latitude < 35.88) %>% # Northern Range Edge
  mutate(year_bin = paste0(floor(year / 5) * 5, "-", floor(year / 5) * 5 + 4)) %>%
  ggplot(aes(x = density_per_m2, color = as.factor(year_bin))) +
  stat_ecdf(geom = "step") +
  labs(title = "Empirical Cumulative Distribution Function",
       color = "5 year period") +
  theme_bw()

# facet by year bin
biodiv_df %>%
  filter(species_lump == "Tegula aureotincta",
         latitude > 32.53 & latitude < 35.88) %>% # Northern Range Edge
  mutate(year_bin = paste0(floor(year / 5) * 5, "-", floor(year / 5) * 5 + 4)) %>%
  ggplot(aes(x = density_per_m2, color = as.factor(year_bin))) +
  stat_ecdf(geom = "step") +
  labs(title = "Empirical Cumulative Distribution Function",
       color = "5 year period") +
  facet_wrap(~year_bin) +
  theme_bw()
```

### Using cumden norm
```{r}
northern_cum_den %>%
  filter(species_lump == "Tegula aureotincta") %>%
  ggplot(aes(x = cum_den_norm)) +
  stat_ecdf(geom = "step", na.rm = TRUE) +
  labs(title = "Empirical Cumulative Distribution Function") +
  theme_bw()
```


